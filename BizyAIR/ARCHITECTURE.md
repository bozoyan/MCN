# BizyAIR Studio - 架构图解

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                      用户浏览器                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              BizyAIR Studio SPA                    │   │
│  │                                                      │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │   │
│  │  │ 画布模式  │ │ 节点模式  │ │ 历史画廊  │ │ 配置管理│ │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └────────┘ │   │
│  │                                                      │   │
│  │  ┌──────────────────────────────────────────────┐  │   │
│  │  │           核心功能层                          │  │   │
│  │  │  • 画布编辑器  • 节点编辑器  • API 集成       │  │   │
│  │  └──────────────────────────────────────────────┘  │   │
│  │                                                      │   │
│  │  ┌──────────────────────────────────────────────┐  │   │
│  │  │           数据持久层                          │  │   │
│  │  │  • localStorage (API Key, 历史记录)          │  │   │
│  │  └──────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP Requests
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌───────────────┐             ┌────────────────┐
│  PHP 后端     │             │  BizyAir API   │
│  (index.php)  │             │  (外部服务)     │
├───────────────┤             └────────────────┘
│               │
│ ┌───────────┐ │
│ │ 路由系统  │ │
│ └───────────┘ │
│               │
│ ┌──────────────────────┐
│ │   API 端点           │
│ ├──────────────────────┤
│ │ GET  /api/configs    │
│ │ GET  /api/config/:id │
│ │ POST /api/config/:id │
│ │ DEL  /api/config/:id │
│ └──────────────────────┘
│               │
│ ┌──────────────────────┐
│ │  文件系统访问        │
│ ├──────────────────────┤
│ │  json/               │
│ │   ├── *.json         │
│ │   └── ...            │
│ └──────────────────────┘
└───────────────┘
```

---

## 数据流图

### 1. 画布模式生成流程

```
用户操作
   │
   ├─► 手绘涂鸦
   ├─► 粘贴图片
   ├─► 输入提示词
   │
   ▼
构建 Payload
   │
   │ {
   │   "web_app_id": 39419,
   │   "input_values": {
   │     "2:LoadImage.image": "data:image/png...",
   │     "3:BizyAir...user_prompt": "提示词",
   │     "1:BizyAir...operation": "edit"
   │   }
   │ }
   │
   ▼
调用 BizyAir API (20分钟超时)
   │
   ├─► 任务创建
   ├─► 轮询状态 (每3秒)
   └─► 获取结果
   │
   ▼
保存到历史
   │
   └─► localStorage
       └─► 最多50条
```

### 2. 配置管理流程

```
用户点击配置文件
   │
   ▼
前端请求: GET /api/config/filename.json
   │
   ▼
PHP 后端处理
   │
   ├─► URL 解码
   ├─► 编码转换
   ├─► 文件读取
   └─► JSON 返回
   │
   ▼
前端显示 (CodeMirror)
   │
   ├─► 用户编辑
   ├─► 保存修改
   │
   ▼
POST /api/config/filename.json
   │
   ▼
PHP 写入文件系统
   │
   └─► json/filename.json
```

### 3. 节点模式工作流

```
用户添加/连接节点
   │
   ├─► LoadImage 节点
   ├─► API 节点
   ├─► Output 节点
   │
   ▼
可视化渲染
   │
   ├─► 节点拖拽
   ├─► 连接线绘制
   ├─► 参数编辑
   │
   ▼
生成 JSON Payload
   │
   ▼
调用 BizyAir API
   │
   ▼
在 Output 节点显示结果
```

---

## 组件关系图

```
┌──────────────────────────────────────────────────────────┐
│                      主应用控制器                         │
│                     (index.php)                          │
└──────────────────────────────────────────────────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 路由处理器   │    │ API 端点     │    │ HTML 渲染器  │
│ (PHP)        │    │ (PHP)        │    │ (HTML/CSS)   │
└──────────────┘    └──────────────┘    └──────────────┘
                             │
                             ▼
                  ┌──────────────────────┐
                  │   JavaScript 核心    │
                  ├──────────────────────┤
                  │ • 全局状态管理       │
                  │ • 模式切换控制器     │
                  │ • 工具函数库         │
                  └──────────────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 画布编辑器   │    │ 节点编辑器   │    │ 配置管理器   │
│              │    │              │    │              │
│ • 绘图引擎   │    │ • 节点系统   │    │ • 文件管理   │
│ • 图片操作   │    │ • 连接线     │    │ • 编辑器     │
│ • 缩放控制   │    │ • 拖拽系统   │    │ • API 调用   │
└──────────────┘    └──────────────┘    └──────────────┘
         │                   │                   │
         └───────────────────┼───────────────────┘
                             ▼
                  ┌──────────────────────┐
                  │    共享服务层         │
                  ├──────────────────────┤
                  │ • API 客户端         │
                  │ • 超时控制           │
                  │ • 本地存储           │
                  │ • 历史记录管理       │
                  └──────────────────────┘
```

---

## 技术栈分层

```
┌────────────────────────────────────────────────────────┐
│                    用户界面层                           │
│  ┌──────────────────────────────────────────────────┐ │
│  │ HTML5 结构                                        │ │
│  │ • 语义化标签 • 无障碍支持 • SEO 友好             │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │ CSS3 样式                                         │ │
│  │ • Flexbox • CSS变量 • 响应式设计 • 动画         │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────┐
│                   应用逻辑层                            │
│  ┌──────────────────────────────────────────────────┐ │
│  │ 原生 JavaScript (ES6+)                           │ │
│  │ • 异步处理 • 模块化 • 事件驱动                   │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │ 第三方库                                          │ │
│  │ • CodeMirror 5.65.2 (代码编辑器)                 │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────┐
│                    后端服务层                           │
│  ┌──────────────────────────────────────────────────┐ │
│  │ PHP 7.4+                                          │ │
│  │ • 路由 • REST API • 文件处理                      │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │ PHP 内置服务器 (开发环境)                         │ │
│  │ • 零配置 • 快速启动 • 路由集成                    │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────┐
│                   数据存储层                            │
│  ┌──────────────────────────────────────────────────┐ │
│  │ 浏览器存储                                        │ │
│  │ • localStorage (API密钥, 历史记录)                │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │ 文件系统                                          │ │
│  │ • json/ (配置文件)                                │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────┐
│                  外部服务层                             │
│  ┌──────────────────────────────────────────────────┐ │
│  │ BizyAir API                                       │ │
│  │ • 视频生成 • 图像处理 • 任务管理                  │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
```

---

## 文件执行流程

```
用户访问: http://127.0.0.1:8004
   │
   ▼
PHP 内置服务器接收请求
   │
   ▼
路由处理 (第 8-26 行)
   │
   ├─► 静态文件? → 直接返回
   └─► 否 → 继续
   │
   ▼
API 请求? (第 36 行)
   │
   ├─► 是 → 处理 API (第 54-118 行)
   │         ├─ GET /api/configs → 返回文件列表
   │         ├─ GET /api/config/:id → 读取配置
   │         ├─ POST /api/config/:id → 保存配置
   │         └─ DELETE /api/config/:id → 删除配置
   │
   └─► 否 → 渲染 HTML (第 121 行开始)
            │
            ├─► 输出 HTML 结构
            ├─► 输出 CSS 样式
            └─► 输出 JavaScript 代码
                 │
                 ▼
           浏览器执行 JavaScript
                 │
                 ├─► 初始化全局状态
                 ├─► 绑定事件监听
                 ├─► 加载历史记录
                 └─► 启动应用
```

---

## 关键技术决策

### 1. 单文件架构
**优点:**
- ✅ 部署简单，只需一个文件
- ✅ 开发快速，无需构建工具
- ✅ 易于理解，代码集中
- ✅ 适合小型项目

**缺点:**
- ❌ 文件较大（1846 行）
- ❌ 不便于多人协作
- ❌ 代码复用困难

### 2. PHP 内置服务器
**优点:**
- ✅ 零配置启动
- ✅ 开发环境快速搭建
- ✅ 路由集成简单

**缺点:**
- ❌ 性能不如 Apache/Nginx
- ❌ 不适合生产环境
- ❌ 缺少高级特性

### 3. localStorage 存储
**优点:**
- ✅ 纯客户端实现
- ✅ 无需服务器存储
- ✅ 快速读写

**缺点:**
- ❌ 容量限制（5-10MB）
- ❌ 仅存储字符串
- ❌ 清除浏览器数据会丢失

### 4. 原生 JavaScript
**优点:**
- ✅ 无框架依赖
- ✅ 学习成本低
- ✅ 性能优异

**缺点:**
- ❌ 缺少状态管理
- ❌ 需要手动处理 DOM
- ❌ 组件化困难

---

## 性能考虑

### 前端优化
1. **事件委托** - 减少监听器数量
2. **防抖处理** - 避免频繁操作
3. **localStorage 缓存** - 减少网络请求
4. **按需加载** - CodeMirror 按需初始化

### 后端优化
1. **静态文件直接服务** - 避免路由开销
2. **JSON 预处理** - 减少运行时转换
3. **文件系统缓存** - PHP 内置服务器自动处理

### API 优化
1. **超时控制** - 避免长时间等待
2. **轮询优化** - 3秒间隔检查状态
3. **错误重试** - 自动处理临时故障

---

## 扩展性建议

### 短期改进
1. 添加用户认证系统
2. 实现云端配置同步
3. 增加更多导出格式
4. 优化移动端适配

### 长期规划
1. 拆分为前后端分离架构
2. 引入现代前端框架（Vue/React）
3. 实现插件系统
4. 添加自动化测试

---

**文档版本**: 1.0.0
**最后更新**: 2025-12-26
